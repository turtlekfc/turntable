<div id="lucky-wheel-wrapper">
    <div id="admin-section" class="card">
        <div id="admin-header" class="header">
            <h3>âš™ï¸ å…§å®¹è¨­å®šèˆ‡æ©Ÿç‡</h3>
            <button onclick="toggleAdmin(true)" class="btn-tool btn-wide">éš±è—è¨­å®š</button>
        </div>
        
        <div id="admin-content">
            <div class="file-ops">
                <button onclick="downloadCSVTemplate()" class="btn-secondary flex-btn">ğŸ“¥ ä¸‹è¼‰ CSV ç¯„ä¾‹</button>
                <label for="csv-upload" class="btn-secondary flex-btn upload-label">ğŸ“‚ åŒ¯å…¥ CSV æª”æ¡ˆ</label>
                <input type="file" id="csv-upload" accept=".csv" onchange="handleFileUpload(this)" style="display: none;">
            </div>
            <div id="file-msg" style="font-size: 12px; color: #666; margin-bottom: 10px; text-align: center; height: 1.2em;"></div>

            <div id="input-group">
                <input type="text" id="new-item-text" placeholder="è¼¸å…¥é¸é …åç¨±" class="input-name">
                <div class="weight-group">
                    <span class="label-text">æ¬Šé‡:</span>
                    <input type="number" id="new-item-weight" value="1" class="input-weight">
                </div>
                <button onclick="addItem()" class="btn-add">æ–°å¢</button>
            </div>
            
            <div class="mode-switch">
                <label class="switch-label">
                    <input type="checkbox" id="hide-text-mode" onchange="drawWheel()"> 
                    ç›²æŠ½æ¨¡å¼ (éš±è—è½‰ç›¤æ–‡å­—)
                </label>
                <button onclick="clearAllItems()" class="btn-danger-small">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
            </div>

            <div class="bg-settings">
                <h4>ğŸ–¥ï¸ å…¨è¢å¹•å¤–è§€è¨­å®š</h4>
                <div class="bg-controls">
                    <label>
                        èƒŒæ™¯é¡è‰²ï¼š
                        <input type="color" id="bg-color-picker" value="#2c3e50" onchange="updateFullscreenBg('color', this.value)">
                    </label>
                    <label class="btn-tool" style="cursor: pointer; display:inline-block; margin-left:10px;">
                        ğŸ–¼ï¸ ä¸Šå‚³åº•åœ–
                        <input type="file" accept="image/*" onchange="updateFullscreenBg('image', this)" style="display: none;">
                    </label>
                    <button onclick="resetBg()" class="btn-tool" style="margin-left:5px;">é‡ç½®</button>
                </div>
                <small style="color:#888;">è¨­å®šåƒ…åœ¨å…¨è¢å¹•æ¨¡å¼ä¸‹ç”Ÿæ•ˆ</small>
            </div>
            
            <div id="item-list-container">
                <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
                <div id="item-list">
                    </div>
            </div>
        </div>
    </div>

    <button id="show-admin-btn" onclick="toggleAdmin(false)" style="display:none; margin-bottom: 10px;" class="btn-tool">ğŸ› ï¸ é¡¯ç¤ºè¨­å®šé¢æ¿</button>

    <div id="wheel-stage">
        <div class="controls" style="margin-bottom: 15px;">
            <button id="fullscreen-btn" onclick="toggleFullScreen()" class="btn-tool">é€²å…¥å…¨è¢å¹• (ESCé€€å‡º)</button>
        </div>
        
        <div class="canvas-container">
            <div id="pointer">â–¼</div>
            <canvas id="wheelCanvas" width="500" height="500"></canvas>
        </div>
        
        <button id="spin-btn" onclick="startSpin()">START</button>
    </div>

    <div id="result-overlay" class="overlay">
        <div class="result-card">
            <h2 style="color:#333;">æŠ½ä¸­çµæœ</h2>
            <div id="winner-text"></div>
            <div class="result-actions">
                <button onclick="closeResult()" class="btn-keep">ä¿ç•™ä¸¦é—œé–‰</button>
                <button id="btn-remove-winner" class="btn-remove">åˆªé™¤æ­¤é …ä¸¦é—œé–‰</button>
            </div>
        </div>
    </div>
</div>

<style id="fs-style"></style>

<style>
    /* åŸºç¤å®¹å™¨ */
    #lucky-wheel-wrapper { font-family: "Microsoft JhengHei", sans-serif; max-width: 800px; margin: auto; text-align: center; background: #f4f4f9; padding: 20px; border-radius: 15px; position: relative; }
    .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: left; }
    
    /* æ¨™é¡Œèˆ‡éš±è—æŒ‰éˆ• */
    .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
    .header h3 { margin: 0; }
    .btn-wide { min-width: 100px; white-space: nowrap; text-align: center; }

    /* 1. CSV æŒ‰éˆ•ç­‰å¯¬æ’ç‰ˆ */
    .file-ops { display: flex; gap: 10px; margin-bottom: 5px; }
    .flex-btn { flex: 1; text-align: center; justify-content: center; display: flex; align-items: center; height: 36px; box-sizing: border-box; }
    .upload-label { margin: 0; line-height: normal; } /* ä¿®æ­£ label è¡Œé«˜ */

    /* 2. è¼¸å…¥æ¡†æ°´å¹³æ’åˆ— */
    #input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; }
    .input-name { flex: 2; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    .weight-group { display: flex; align-items: center; gap: 5px; white-space: nowrap; }
    .label-text { font-size: 14px; color: #555; font-weight: bold; }
    .input-weight { width: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center; }
    .btn-add { flex: 0 0 auto; background: #2ecc71; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; height: 35px; }

    /* 3. ç›²æŠ½èˆ‡æ¸…ç©º (å·¦å³åˆ†é–‹) */
    .mode-switch { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px; }
    .switch-label { cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: bold; color: #555; }

    /* èƒŒæ™¯è¨­å®šå€ */
    .bg-settings { background: #eef2f3; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e1e1e1; }
    .bg-settings h4 { margin: 0 0 10px 0; font-size: 14px; color: #555; }
    .bg-controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }

    /* æ¸…å–®åˆ—è¡¨ */
    .item-row { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; background: #fff; padding: 6px; border-radius: 4px; border-bottom: 1px solid #eee; }
    .item-row input[type="text"] { flex: 1; padding: 5px; border: 1px solid #ddd; }

    /* è½‰ç›¤è¦–è¦º */
    .canvas-container { position: relative; display: inline-block; margin: 20px 0; }
    #pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); font-size: 40px; color: #e74c3c; z-index: 10; text-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    #wheelCanvas { max-width: 100%; height: auto; border-radius: 50%; background: #fff; }
    #spin-btn { background: #e74c3c; color: white; border: none; padding: 15px 60px; font-size: 24px; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #c0392b; transition: 0.2s; }
    #spin-btn:hover { background: #ff4757; }
    #spin-btn:active { transform: translateY(3px); box-shadow: none; }

    /* å…¨è¢å¹•æ¨£å¼æ§åˆ¶ */
    #lucky-wheel-wrapper:fullscreen { 
        width: 100vw; height: 100vh; 
        display: flex; flex-direction: column; justify-content: center; 
        /* é è¨­èƒŒæ™¯ï¼Œæœƒè¢« JS å‹•æ…‹è¦†è“‹ */
        background-color: #2c3e50; 
        background-position: center;
        background-size: cover;
        background-repeat: no-repeat;
    }
    #lucky-wheel-wrapper:fullscreen .card { display: none; }
    #lucky-wheel-wrapper:fullscreen #show-admin-btn { display: none !important; }
    #lucky-wheel-wrapper:fullscreen #fullscreen-btn { display: none; }
    
    /* é€šç”¨æŒ‰éˆ•æ¨£å¼ */
    .btn-tool { padding: 6px 12px; background: #636e72; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
    .btn-remove { background: #e74c3c; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .btn-keep { background: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .btn-secondary { background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
    .btn-danger-small { background: #e74c3c; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; }

    /* å½ˆçª— */
    .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; justify-content: center; align-items: center; pointer-events: auto; }
    .result-card { background: white; padding: 40px; border-radius: 20px; text-align: center; min-width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    #winner-text { font-size: 48px; font-weight: bold; color: #e74c3c; margin: 25px 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    .result-actions { display: flex; gap: 15px; justify-content: center; }
</style>

<script>
    let items = [
        { id: 1, text: "å¤§å‰", weight: 1, color: "#f1c40f", active: true },
        { id: 2, text: "ä¸­å‰", weight: 1, color: "#e67e22", active: true },
        { id: 3, text: "å°å‰", weight: 1, color: "#e74c3c", active: true }
    ];

    const canvas = document.getElementById('wheelCanvas');
    const ctx = canvas.getContext('2d');
    let currentRotation = 0;
    let isSpinning = false;
    const colorsPool = ["#f1c40f", "#e67e22", "#e74c3c", "#9b59b6", "#3498db", "#2ecc71", "#1abc9c", "#f39c12"];

    // --- å…¨è¢å¹•èƒŒæ™¯æ§åˆ¶ ---
    function updateFullscreenBg(type, val) {
        const styleTag = document.getElementById('fs-style');
        if (type === 'color') {
            styleTag.innerHTML = `#lucky-wheel-wrapper:fullscreen { background-image: none !important; background-color: ${val} !important; }`;
        } else if (type === 'image') {
            const file = val.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    styleTag.innerHTML = `#lucky-wheel-wrapper:fullscreen { background-image: url('${e.target.result}') !important; background-color: black !important; }`;
                };
                reader.readAsDataURL(file);
            }
        }
    }

    function resetBg() {
        document.getElementById('bg-color-picker').value = "#2c3e50";
        document.getElementById('fs-style').innerHTML = ""; // å›å¾©é è¨­ CSS
    }

    // --- CSV åŠŸèƒ½ ---
    function downloadCSVTemplate() {
        const csvContent = "\uFEFFåç¨±,æ¬Šé‡\nå¤§ç,1\näºŒç,5\nåƒåŠ ç,10";
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "æŠ½çåå–®ç¯„ä¾‹.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            parseCSV(e.target.result);
            input.value = ''; 
        };
        reader.readAsText(file);
    }

    function parseCSV(text) {
        const lines = text.split(/\r\n|\n/);
        let newCount = 0;
        let startIndex = (lines[0].includes("åç¨±") || lines[0].includes("text")) ? 1 : 0;

        for (let i = startIndex; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            const parts = line.split(',');
            if (parts.length >= 1) {
                const name = parts[0].trim();
                const weight = parts[1] ? parseFloat(parts[1]) : 1;
                if (name) {
                    items.push({
                        id: Date.now() + Math.random(),
                        text: name,
                        weight: isNaN(weight) ? 1 : weight,
                        color: colorsPool[items.length % colorsPool.length],
                        active: true
                    });
                    newCount++;
                }
            }
        }
        renderList();
        const msg = document.getElementById('file-msg');
        msg.innerText = `âœ… æˆåŠŸåŒ¯å…¥ ${newCount} ç­†è³‡æ–™`;
        msg.style.color = "green";
        setTimeout(() => msg.innerText = '', 3000);
    }

    // --- åŸºç¤åŠŸèƒ½ ---
    function clearAllItems() {
        if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰é¸é …å—ï¼Ÿ")) {
            items = [];
            renderList();
        }
    }

    function toggleAdmin(isHide) {
        document.getElementById('admin-section').style.display = isHide ? 'none' : 'block';
        document.getElementById('show-admin-btn').style.display = isHide ? 'inline-block' : 'none';
    }

    function toggleFullScreen() {
        const elem = document.getElementById('lucky-wheel-wrapper');
        if (!document.fullscreenElement) {
            elem.requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    }

    function renderList() {
        const list = document.getElementById('item-list');
        list.innerHTML = '';
        items.forEach((item, index) => {
            list.innerHTML += `
                <div class="item-row">
                    <input type="checkbox" ${item.active ? 'checked' : ''} onchange="toggleItem(${index})">
                    <input type="text" value="${item.text}" onchange="updateItem(${index}, 'text', this.value)">
                    <span style="font-size:12px; color:#888;">æ¬Šé‡:</span>
                    <input type="number" value="${item.weight}" onchange="updateItem(${index}, 'weight', this.value)" style="width:60px; padding:5px; border:1px solid #ddd; border-radius:3px;">
                    <button onclick="removeItem(${index})" style="background:none; border:none; cursor:pointer;">ğŸ—‘ï¸</button>
                </div>`;
        });
        drawWheel();
    }

    function addItem() {
        const text = document.getElementById('new-item-text').value;
        const weight = parseFloat(document.getElementById('new-item-weight').value) || 1;
        if (!text) return;
        items.push({ id: Date.now(), text, weight, color: colorsPool[items.length % colorsPool.length], active: true });
        document.getElementById('new-item-text').value = '';
        renderList();
    }

    function removeItem(index) { items.splice(index, 1); renderList(); }
    function toggleItem(index) { items[index].active = !items[index].active; renderList(); }
    function updateItem(index, key, val) { 
        items[index][key] = (key === 'weight') ? parseFloat(val) : val; 
        drawWheel(); 
    }

    function drawWheel() {
        const activeItems = items.filter(i => i.active);
        if (activeItems.length === 0) {
            ctx.clearRect(0, 0, 500, 500);
            return;
        }
        
        const totalWeight = activeItems.reduce((s, i) => s + i.weight, 0);
        let startAngle = currentRotation - Math.PI/2; 
        const hideText = document.getElementById('hide-text-mode').checked;

        ctx.clearRect(0, 0, 500, 500);
        activeItems.forEach(item => {
            const sliceAngle = (item.weight / totalWeight) * 2 * Math.PI;
            ctx.beginPath();
            ctx.fillStyle = item.color;
            ctx.moveTo(250, 250);
            ctx.arc(250, 250, 240, startAngle, startAngle + sliceAngle);
            ctx.closePath();
            ctx.fill();
            ctx.strokeStyle = "white";
            ctx.lineWidth = 2;
            ctx.stroke();

            if (!hideText) {
                ctx.save();
                ctx.translate(250, 250);
                ctx.rotate(startAngle + sliceAngle/2);
                ctx.textAlign = "right";
                ctx.fillStyle = "white";
                ctx.font = "bold 20px Arial";
                ctx.fillText(item.text, 230, 8);
                ctx.restore();
            }
            startAngle += sliceAngle;
        });
    }

    function startSpin() {
        if (isSpinning) return;
        const activeItems = items.filter(i => i.active);
        if (activeItems.length < 1) return alert("è«‹å…ˆåŠ å…¥ä¸¦å‹¾é¸é …ç›®");

        isSpinning = true;
        const duration = 5000;
        const startTimestamp = performance.now();
        const spinRounds = 8 + Math.random() * 5;
        const finalExtra = Math.random() * Math.PI * 2;
        const totalSpin = spinRounds * Math.PI * 2 + finalExtra;
        const initialRotation = currentRotation;

        function animate(now) {
            const elapsed = now - startTimestamp;
            const progress = Math.min(elapsed / duration, 1);
            const easeOut = 1 - Math.pow(1 - progress, 4);
            
            currentRotation = initialRotation + (totalSpin * easeOut);
            drawWheel();

            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                isSpinning = false;
                showResult();
            }
        }
        requestAnimationFrame(animate);
    }

    function showResult() {
        const activeItems = items.filter(i => i.active);
        const totalWeight = activeItems.reduce((s, i) => s + i.weight, 0);
        let normalized = ( (2 * Math.PI) - (currentRotation % (2 * Math.PI)) ) % (2 * Math.PI);
        let cumulativeAngle = 0;
        let winner = activeItems[0];
        
        for (let item of activeItems) {
            const sliceAngle = (item.weight / totalWeight) * 2 * Math.PI;
            if (normalized >= cumulativeAngle && normalized < cumulativeAngle + sliceAngle) {
                winner = item;
                break;
            }
            cumulativeAngle += sliceAngle;
        }

        document.getElementById('winner-text').innerText = winner.text;
        document.getElementById('result-overlay').style.display = 'flex';
        
        document.getElementById('btn-remove-winner').onclick = function() {
            const idx = items.findIndex(i => i.id === winner.id);
            if (idx !== -1) items.splice(idx, 1);
            closeResult();
            renderList();
        };
    }

    function closeResult() {
        document.getElementById('result-overlay').style.display = 'none';
    }

    renderList();
</script>